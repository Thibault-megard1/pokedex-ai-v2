# PokÃ©mon Game Feature - Implementation Guide

## Overview

A fully playable PokÃ©mon-style top-down adventure game built with **Phaser 3**, featuring:
- Keyboard-controlled player movement
- Wild PokÃ©mon encounters in tall grass
- NPC interactions with **local AI (Ollama)** integration
- Turn-based battle system
- Save/load game system
- In-game menu (ESC)
- Inventory and team management

## Getting Started

### 1. Install Dependencies

Phaser 3 has been added to `package.json`. To install:

```bash
npm install --legacy-peer-deps
```

### 2. Start the Development Server

```bash
npm run dev
```

### 3. Access the Game

Navigate to: `http://localhost:3000/game`

The game will automatically:
- Hide the navigation bar for immersive experience
- Load your save file (or create a new one)
- Start the Phaser engine

## File Structure

```
ğŸ“ lib/game/
â”œâ”€â”€ types.ts              # TypeScript interfaces for game data
â”œâ”€â”€ saveManager.ts        # Save/load game state
â”œâ”€â”€ maps.ts              # Map definitions and encounter tables
â””â”€â”€ ğŸ“ scenes/
    â”œâ”€â”€ BootScene.ts     # Asset loading
    â”œâ”€â”€ MenuScene.ts     # Title screen
    â”œâ”€â”€ GameScene.ts     # Main gameplay (movement, NPCs, world)
    â””â”€â”€ BattleScene.ts   # Wild PokÃ©mon battles

ğŸ“ components/game/
â””â”€â”€ GameCanvas.tsx       # React component wrapping Phaser

ğŸ“ app/
â”œâ”€â”€ game/page.tsx        # Game route (hides navbar)
â””â”€â”€ ğŸ“ api/
    â”œâ”€â”€ game/save/route.ts    # Save/load API endpoints
    â””â”€â”€ ai/npc/route.ts       # NPC dialogue API with Ollama

ğŸ“ public/game/
â”œâ”€â”€ ASSET_README.md      # Asset placement guide
â””â”€â”€ ğŸ“ assets/           # Game assets (sprites, tiles, UI)
    â”œâ”€â”€ player/
    â”œâ”€â”€ npcs/
    â”œâ”€â”€ tiles/
    â””â”€â”€ ui/

ğŸ“ data/
â””â”€â”€ game-saves/          # JSON save files (per user)
```

## Keyboard Controls

| Key | Action |
|-----|--------|
| â¬†ï¸â¬‡ï¸â¬…ï¸â¡ï¸ | Move player |
| **SPACE** | Interact with NPCs |
| **ESC** | Open/close menu |
| **I** | Open inventory |
| **T** | View team |
| **R** | Run (in battle) |

## Game Flow

### 1. Start Screen
- Press SPACE to begin
- Loads save data for logged-in user

### 2. Professor's Lab
- Starting location
- Talk to Professor Oak (AI-powered NPC)
- Get first PokÃ©mon (starter selection)

### 3. Route 1
- Explore outdoor area
- Walk through tall grass to encounter wild PokÃ©mon
- Battle and gain EXP

### 4. Wild Battles
- Turn-based combat
- Choose Attack or Run
- Defeat PokÃ©mon to gain EXP

### 5. NPCs
- Interact with trainers
- Dialogues generated by **Ollama AI** (or fallback text)
- Get tips and lore

### 6. Menu System
- Press ESC to open
- Save game manually
- View team/inventory

## Maps

### Lab Map
- Size: 10x8 tiles
- NPCs: Professor Oak
- Exits: Door to Route 1

### Route 1
- Size: 15x20 tiles
- Tall grass patches (wild encounters)
- NPCs: Youngster Joey
- Exits: Back to Lab

**To add new maps**: Edit `lib/game/maps.ts`

## Encounters

Wild PokÃ©mon spawn in tall grass with configurable rates:

```typescript
// Example: Route 1 encounters
{
  pokemon: 25,        // Pikachu (PokÃ©dex ID)
  minLevel: 3,
  maxLevel: 5,
  chance: 5           // 5% encounter rate
}
```

**Encounter chance per step**: 15% (when in tall grass)

## NPC AI System

NPCs can use **Ollama** for dynamic dialogues:

```typescript
{
  id: 'professor',
  name: 'Professor Oak',
  useAI: true,
  aiContext: "You are Professor Oak, a friendly PokÃ©mon researcher..."
}
```

### Ollama Setup

1. Install Ollama: https://ollama.ai
2. Pull a model: `ollama pull llama2`
3. Set environment variable:
   ```bash
   OLLAMA_API_URL=http://localhost:11434
   ```

**Fallback**: If Ollama is unavailable, uses predefined dialogues.

## Save System

### Save File Location
`data/game-saves/{username}.json`

### What's Saved
- Player position (x, y, map)
- PokÃ©mon team (up to 6)
- Inventory items
- Badges collected
- Money
- Play time
- Story flags

### Auto-Save
Automatically saves every **30 seconds** during gameplay.

### Manual Save
Press **ESC** â†’ **[S] Save Game**

## Battle System

### Simple Turn-Based Combat
1. Player attacks or runs
2. Enemy attacks (if player didn't run)
3. Repeat until:
   - Enemy HP reaches 0 (victory)
   - Player HP reaches 0 (defeat)
   - Player successfully runs away

### Damage Calculation
```
damage = (attacker.attack / defender.defense) * baseMultiplier + random(0-5)
```

### EXP Gain
```
expGained = enemyLevel * 15
```

## Adding Assets

See [public/game/ASSET_README.md](../../public/game/ASSET_README.md) for detailed asset requirements.

### Quick Guide
1. Create PNG sprites (32x32 for characters)
2. Place in appropriate folder:
   - `public/game/assets/player/`
   - `public/game/assets/npcs/`
   - `public/game/assets/tiles/`
3. Refresh game - assets load automatically

**Fallback Graphics**: If assets are missing, the game creates colored rectangles as placeholders.

## Extending the Game

### Add a New Map

1. Define map in `lib/game/maps.ts`:
```typescript
export const NEW_MAP: MapData = {
  name: 'new_map',
  width: 20,
  height: 15,
  tileSize: 32,
  layers: { ground: [...], collision: [...], grass: [...] },
  npcs: [...],
  warps: [...]
};
```

2. Add to registry:
```typescript
export const MAPS: Record<string, MapData> = {
  lab: LAB_MAP,
  route1: ROUTE1_MAP,
  new_map: NEW_MAP,
};
```

### Add a New NPC

```typescript
{
  id: 'nurse_joy',
  name: 'Nurse Joy',
  x: 5,
  y: 3,
  sprite: 'nurse',
  dialogues: ["Welcome to the PokÃ©mon Center!"],
  useAI: true,
  aiContext: "You are Nurse Joy. You heal PokÃ©mon and provide medical advice.",
  onInteract: 'heal_pokemon', // Special event trigger
}
```

### Add New Wild PokÃ©mon

Edit `ENCOUNTER_TABLES` in `lib/game/maps.ts`:

```typescript
route1: [
  { pokemon: 1, minLevel: 2, maxLevel: 4, chance: 30 }, // Bulbasaur
  // Add more...
]
```

## Troubleshooting

### Game Won't Load
- Check browser console for errors
- Ensure Phaser installed: `npm list phaser`
- Try clearing browser cache

### Assets Not Showing
- Check file paths match exactly (case-sensitive)
- Look for "loaderror" in console
- Fallback graphics should appear if assets missing

### Save Not Working
- Check `data/game-saves/` directory exists
- Verify API route: `/api/game/save`
- Check browser console for fetch errors

### Ollama Not Responding
- Ensure Ollama is running: `ollama serve`
- Check `OLLAMA_API_URL` in `.env.local`
- NPCs will use fallback dialogues if AI unavailable

## Performance Tips

1. **Reduce Camera Zoom**: In `GameScene.ts`:
   ```typescript
   this.cameras.main.setZoom(1.5); // Lower value = better performance
   ```

2. **Disable Debug Mode**: In `GameCanvas.tsx`:
   ```typescript
   physics: {
     arcade: { debug: false }
   }
   ```

3. **Optimize Maps**: Keep map sizes reasonable (< 50x50 tiles)

## API Endpoints

### GET /api/game/save?username={username}
Loads save file for user.

**Response**:
```json
{
  "save": { ... }
}
```

### POST /api/game/save
Saves game state.

**Request**:
```json
{
  "save": { ... }
}
```

### POST /api/ai/npc
Gets NPC dialogue from Ollama or fallback.

**Request**:
```json
{
  "npcName": "Professor Oak",
  "context": "...",
  "playerMessage": "Hello!"
}
```

**Response**:
```json
{
  "dialogue": "Welcome to the world of PokÃ©mon!",
  "source": "ollama"
}
```

## Future Enhancements

- [ ] PokÃ©mon Center (heal team)
- [ ] PokÃ© Mart (buy items)
- [ ] Trainer battles (NPC trainers)
- [ ] More maps and regions
- [ ] Evolution system
- [ ] Trading system
- [ ] Mini-games
- [ ] Sound effects and music
- [ ] Mobile touch controls

## Credits

- **Game Engine**: Phaser 3 (https://phaser.io)
- **Framework**: Next.js 14 + React 18
- **AI**: Ollama (local LLM)
- **PokÃ©mon Data**: PokeAPI (https://pokeapi.co)

---

**Enjoy your PokÃ©mon adventure!** ğŸ®âœ¨
